<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>GTU - Récupération identifiants</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 30px; }
    input { margin: 6px 0; padding:6px; width: 300px; }
    button { padding:8px 12px; }
    #result { margin-top: 14px; }
  </style>
</head>
<body>
  <h2>Récupération des identifiants Moodle</h2>

  <form id="student-form">
    <input type="text" name="firstname" placeholder="First name" required /><br/>
    <input type="text" name="lastname" placeholder="Last name" required /><br/>
    <input type="text" name="num_inscreption" placeholder="Registration number" required /><br/>
    <button type="submit">Check Credentials</button>
  </form>

  <div id="result"></div>

<script>
document.getElementById("student-form").addEventListener("submit", async (e) => {
  e.preventDefault();
  const form = e.target;
  const fd = new FormData(form);
  const params = new URLSearchParams(fd).toString();
  const response = await fetch(`/get_credentials/?${params}`);
  const resultDiv = document.getElementById("result");
  resultDiv.innerHTML = "";

  if (response.ok) {
    const data = await response.json();
    resultDiv.innerHTML = `
      <p><strong>Username:</strong> ${data.username}</p>
      <p><strong>Password:</strong> ${data.password}</p>
      <button id="download-pdf">Download PDF</button>
    `;
    document.getElementById("download-pdf").addEventListener("click", () => {
      // open pdf in new tab
      window.open(`/get_credentials_pdf/?${params}`, "_blank");
    });
  } else {
    const err = await response.json();
    const msg = err.error || err.detail || "Error";
    resultDiv.innerHTML = `<p style="color:red;">${msg}</p>`;
  }
});
</script>
</body>
</html>
